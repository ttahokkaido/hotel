<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPENæ¡‘ æˆ¿åƒ¹æœˆæ›†</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel (ç”¨æ–¼è§£æ JSX - åƒ…é™é–‹ç™¼/é è¦½ç’°å¢ƒ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. è¼‰å…¥ LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { margin: 0; padding: 0; background-color: #f0f2f5; display: flex; justify-content: center; min-height: 100vh; }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out forwards;
        }
        
        .hard-blur {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
    </style>
</head>
<body>
    <div id="root" class="w-full h-full flex justify-center"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, memo } = React;
        
        // ==========================================
        // 1. Utils & Config
        // ==========================================
        
        const CONFIG = {
            LIFF_ID: "2008400942-3JbRekRM",
            OFFICIAL_LINE_URL: "https://lin.ee/LTFdIJo",
            N8N_WEBHOOK_URL: "https://ez2.zeabur.app/webhook/73304ca6-28ae-450a-829d-bd66c2a09919"
        };

        const DateUtils = {
            formatLocalYYYYMMDD: (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            getDaysInMonth: (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay, year, month };
            },
            getDiffDaysFromToday: (targetDate) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const target = new Date(targetDate);
                target.setHours(0, 0, 0, 0);
                const diffTime = target - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
        };

        const STYLES = {
            TAG: {
                "ğŸ”µä½é»": "bg-blue-50 text-blue-700 border-blue-200 ring-1 ring-blue-100",
                "ğŸŸ¢ä¾¿å®œ": "bg-green-50 text-green-700 border-green-200 ring-1 ring-green-100",
                "ğŸŸ¡æ­£å¸¸": "bg-yellow-50 text-yellow-700 border-yellow-200 ring-1 ring-yellow-100",
                "ğŸŸ å°è²´": "bg-orange-50 text-orange-700 border-orange-200 ring-1 ring-orange-100",
                "ğŸ”´éç†±": "bg-red-50 text-red-700 border-red-200 ring-1 ring-red-100",
                "DEFAULT": "bg-gray-50 text-gray-400 border-gray-100"
            },
            LOCKED_GOLD: "bg-amber-100 text-amber-800 border-amber-300 ring-1 ring-amber-200"
        };

        const getTagStyle = (tag) => {
            if (!tag) return STYLES.TAG.DEFAULT;
            const found = Object.keys(STYLES.TAG).find(k => tag.includes(k));
            return found ? STYLES.TAG[found] : STYLES.TAG.DEFAULT;
        };

        const FAKE_TAGS = ["ğŸ”µä½é»", "ğŸŸ¢ä¾¿å®œ", "ğŸŸ¡æ­£å¸¸", "ğŸŸ å°è²´", "ğŸ”´éç†±"];
        const ALL_TAG_STYLES = Object.values(STYLES.TAG).filter(s => !s.includes('gray'));

        const getFakeDataIndex = (year, month, day) => {
            const seed = year * 10000 + (month + 1) * 100 + day;
            return seed % ALL_TAG_STYLES.length;
        };

        // ==========================================
        // 2. UI Components
        // ==========================================

        const IconBase = memo(({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        ));

        const ChevronLeft = memo((props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>);
        const ChevronRight = memo((props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>);
        const MapPin = memo((props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>);
        const Building2 = memo((props) => <IconBase {...props}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>);
        const Snowflake = memo((props) => <IconBase {...props}><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 16-4-4 4-4"/><path d="m4 8 4 4-4 4"/><path d="m16 4-4 4-4-4"/><path d="m8 20 4-4 4 4"/></IconBase>);
        const Utensils = memo((props) => <IconBase {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconBase>);
        const Landmark = memo((props) => <IconBase {...props}><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></IconBase>);
        const Waves = memo((props) => <IconBase {...props}><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/></IconBase>);
        const Palmtree = memo((props) => <IconBase {...props}><path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2l1-1h1l1 1h4l1-1h1l1 1h2l1-1h1l1 1h4"/><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-3l-1-1h-1l-1 1h-3"/><path d="M5.8 9.5a4 4 0 0 1 7.4 0"/><path d="M9 12v10"/></IconBase>);
        const Info = memo((props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>);
        const Sparkles = memo((props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></IconBase>);
        const ArrowRight = memo((props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>);
        const ExternalLink = memo((props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>);
        const Hotel = memo((props) => <IconBase {...props}><path d="M10 22v-6.57"/><path d="M12 11h.01"/><path d="M12 7h.01"/><path d="M14 15.43V22"/><path d="M15 16a5 5 0 0 0-6 0"/><path d="M16 11h.01"/><path d="M16 7h.01"/><path d="M8 11h.01"/><path d="M8 7h.01"/><rect x="4" y="2" width="16" height="20" rx="2"/></IconBase>);
        const Loader2 = memo((props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>);
        const AlertCircle = memo((props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>);
        const Lock = memo((props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>);
        const UserPlus = memo((props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></IconBase>);

        const CITIES = [
            { id: 'Tokyo', name: 'æ±äº¬', icon: Building2, color: 'text-purple-600' },
            { id: 'Sapporo', name: 'æœ­å¹Œ', icon: Snowflake, color: 'text-blue-500' },
            { id: 'Osaka', name: 'å¤§é˜ª', icon: Utensils, color: 'text-orange-500' },
            { id: 'Kyoto', name: 'äº¬éƒ½', icon: Landmark, color: 'text-red-600' },
            { id: 'Fukuoka', name: 'ç¦å²¡', icon: Waves, color: 'text-teal-600' },
            { id: 'Okinawa', name: 'æ²–ç¹©', icon: Palmtree, color: 'text-green-600' }
        ];

        const DEFAULT_INSIGHTS = {
            Tokyo: { analysis: "AI åˆ†ææ•¸æ“šè¼‰å…¥ä¸­...", articleUrl: "#", agodaUrl: "#" },
            Sapporo: { analysis: "AI åˆ†ææ•¸æ“šè¼‰å…¥ä¸­...", articleUrl: "#", agodaUrl: "#" },
            Osaka: { analysis: "AI åˆ†ææ•¸æ“šè¼‰å…¥ä¸­...", articleUrl: "#", agodaUrl: "#" },
            Kyoto: { analysis: "AI åˆ†ææ•¸æ“šè¼‰å…¥ä¸­...", articleUrl: "#", agodaUrl: "#" },
            Fukuoka: { analysis: "AI åˆ†ææ•¸æ“šè¼‰å…¥ä¸­...", articleUrl: "#", agodaUrl: "#" },
            Okinawa: { analysis: "AI åˆ†ææ•¸æ“šè¼‰å…¥ä¸­...", articleUrl: "#", agodaUrl: "#" }
        };

        const GatekeeperModal = memo(() => (
            <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-md flex items-center justify-center p-6">
                <div className="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl animate-fade-in-up">
                    <div className="mb-6 flex justify-center">
                        <div className="bg-green-100 p-4 rounded-full">
                            <UserPlus size={48} className="text-green-600" />
                        </div>
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">è«‹ä½¿ç”¨ LINE é–‹å•Ÿ</h2>
                    <p className="text-gray-600 mb-8 leading-relaxed">
                        æœ¬æœå‹™ç‚ºåŒ—æµ·é“ OPENæ¡‘ å®˜æ–¹ LINE å°ˆå±¬åŠŸèƒ½ã€‚è«‹åŠ å…¥å¥½å‹ä¸¦é€éé¸å–®é–‹å•Ÿï¼Œä»¥ç²å¾—å®Œæ•´é«”é©—ã€‚
                    </p>
                    <a href={CONFIG.OFFICIAL_LINE_URL} className="block w-full bg-[#06C755] hover:bg-[#05b64d] text-white font-bold py-4 rounded-xl transition-all active:scale-95 shadow-lg flex items-center justify-center gap-2">
                        <span>åŠ å…¥å®˜æ–¹ LINE å¥½å‹</span>
                        <ArrowRight size={20} />
                    </a>
                </div>
            </div>
        ));

        const Header = memo(({ selectedCity, onSelectCity }) => (
            <div className="px-4 pt-4 pb-2 bg-white flex-none">
                <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <MapPin className="text-red-600 fill-red-50" size={20} />
                    <span>OPENæ¡‘ æˆ¿åƒ¹æœˆæ›†</span>
                </h1>
                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar scroll-smooth px-1">
                    {CITIES.map((city) => {
                        const isSelected = selectedCity.id === city.id;
                        const Icon = city.icon;
                        return (
                            <button key={city.id} onClick={() => onSelectCity(city)} className={`flex flex-col items-center justify-center min-w-[68px] py-2 px-1 rounded-2xl transition-all duration-300 border ${isSelected ? 'bg-white border-red-100 shadow-md scale-100 z-10' : 'bg-transparent border-transparent hover:bg-gray-50/50 scale-95 text-gray-400 opacity-80'}`}>
                                <div className={`p-2 rounded-full mb-1.5 transition-colors duration-300 ${isSelected ? 'bg-red-50' : 'bg-gray-100/50'}`}><Icon size={20} className={isSelected ? city.color : 'text-gray-400'} /></div>
                                <span className={`text-sm font-bold tracking-wide whitespace-nowrap ${isSelected ? 'text-gray-800' : 'text-gray-400'}`}>{city.name}</span>
                            </button>
                        );
                    })}
                </div>
            </div>
        ));

        const Navigator = memo(({ currentDate, onPrevMonth, onNextMonth }) => {
            const formatMonthTitle = (date) => `${date.getFullYear()}å¹´ ${date.getMonth() + 1}æœˆ`;
            return (
                <div className="flex items-center justify-between px-4 py-2 border-t border-gray-100 bg-white flex-none">
                    <button onClick={onPrevMonth} className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600"><ChevronLeft size={24} /></button>
                    <h2 className="text-lg font-bold text-gray-800">{formatMonthTitle(currentDate)}</h2>
                    <button onClick={onNextMonth} className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-600"><ChevronRight size={24} /></button>
                </div>
            );
        });

        const WeekdayHeaders = memo(() => (
            <div className="bg-white grid grid-cols-7 border-b border-gray-100 pb-2 pt-1 flex-none">
                {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map((d, i) => (
                    <div key={d} className={`text-center text-sm font-bold ${i === 0 || i === 6 ? 'text-red-500' : 'text-gray-500'}`}>{d}</div>
                ))}
            </div>
        ));

        const CalendarGrid = memo(({ days, firstDay, year, month, data, selectedCityId }) => {
            const calendarCells = useMemo(() => {
                const cells = [];
                for (let i = 0; i < firstDay; i++) cells.push(null);
                for (let i = 1; i <= days; i++) cells.push(i);
                return cells;
            }, [days, firstDay]);

            return (
                <div className="grid grid-cols-7 gap-1 md:gap-2 mb-6 pt-2">
                    {calendarCells.map((day, idx) => {
                        if (!day) return <div key={`empty-${idx}`} className="h-[72px]"></div>;

                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const diffDays = DateUtils.getDiffDaysFromToday(new Date(year, month, day));
                        
                        const isLockRange = diffDays > 30 && diffDays < 150;
                        const dayData = data[dateStr]?.[selectedCityId];
                        
                        // é–å®šåˆ¤å®šï¼šåœ¨é–å®šç¯„åœå…§ï¼Œä¸”ç„¡è³‡æ–™ (æˆ–å¾Œç«¯æ¸…æ´—)
                        const isLocked = isLockRange && (!dayData || !dayData.tag || dayData.tag === 'ğŸ”’' || dayData.tag === 'âš ï¸ ç„¡æ•¸æ“š');

                        let displayTag = "", displayIndex = null, cellStyle = "";

                        if (isLocked) {
                            const fakeIndex = getFakeDataIndex(year, month, day);
                            const fakeTag = FAKE_TAGS[fakeIndex];
                            displayTag = fakeTag; 
                            displayIndex = 20 + (fakeIndex * 15);
                            cellStyle = STYLES.LOCKED_GOLD;
                        } else {
                            const tag = dayData?.tag || "âš ï¸ ç„¡æ•¸æ“š";
                            displayTag = tag;
                            displayIndex = dayData?.index;
                            cellStyle = getTagStyle(tag);
                        }

                        return (
                            <div key={dateStr} className={`h-[72px] flex flex-col justify-between p-1.5 rounded-lg border transition-all relative overflow-hidden ${cellStyle} ${isLocked ? 'cursor-not-allowed select-none' : 'hover:scale-105 shadow-sm'} ${(!dayData && !isLocked) || (dayData?.tag === 'âš ï¸ ç„¡æ•¸æ“š') ? 'opacity-50' : ''}`}>
                                {isLocked && (
                                    <div className="absolute inset-0 z-20 backdrop-blur-[6px] bg-white/40 flex items-center justify-center">
                                        <Lock size={16} className="text-gray-600 opacity-80" />
                                    </div>
                                )}
                                <span className={`text-sm font-semibold relative z-10 ${(!dayData && !isLocked) || (dayData?.tag === 'âš ï¸ ç„¡æ•¸æ“š') ? 'text-gray-400' : 'text-gray-600'}`}>{day}</span>
                                {(dayData || isLocked) && (displayTag !== "âš ï¸ ç„¡æ•¸æ“š") ? (
                                    <div className={`flex flex-col items-center justify-center h-full pb-4 gap-1 relative z-10 ${isLocked ? 'blur-[4px] opacity-70' : ''}`}>
                                        <span className="text-lg md:text-xl font-bold leading-tight text-center break-words w-full">{displayTag}</span>
                                        {displayIndex !== null && <span className="text-xs opacity-70 font-mono font-bold">{displayIndex}</span>}
                                    </div>
                                ) : (
                                    <div className="h-full flex items-center justify-center relative z-10"><span className="text-xs text-gray-300">-</span></div>
                                )}
                            </div>
                        );
                    })}
                </div>
            );
        });

        // ä¿®æ­£ï¼šAnalysisSection æ¥æ”¶ isLocked åƒæ•¸
        const AnalysisSection = memo(({ insight, isLocked, selectedCityName }) => (
            <div className="px-1">
                <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-100 shadow-sm relative overflow-hidden">
                    <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-purple-200 rounded-full opacity-20 blur-xl"></div>
                    <div className="flex items-center gap-2 mb-3 relative z-10">
                        <div className="bg-white p-1.5 rounded-full shadow-sm border border-indigo-100"><Sparkles className="text-indigo-600" size={24} /></div>
                        <h3 className="font-bold text-indigo-900 text-lg md:text-xl">OPENæ¡‘ æˆ¿åƒ¹åˆ†æ & å»ºè­°</h3>
                    </div>
                    <div className="relative z-10 mb-4">
                        <p className={`text-base md:text-lg text-indigo-800 leading-relaxed text-justify whitespace-pre-line ${isLocked ? 'pb-2' : ''}`}>
                            {insight?.analysis || "æš«ç„¡åˆ†ææ•¸æ“š"}
                        </p>
                        {isLocked && (
                            <div className="absolute inset-x-0 bottom-0 h-[75%] backdrop-blur-[6px] bg-gradient-to-b from-transparent to-indigo-50/80 flex items-end justify-center pb-2">
                                <span className="text-indigo-900/60 font-bold text-sm bg-white/50 px-3 py-1 rounded-full shadow-sm backdrop-blur-md">ğŸ”’ è¨‚é–±è§£é–å®Œæ•´åˆ†æ</span>
                            </div>
                        )}
                    </div>
                    <div className="space-y-2 relative z-10">
                        <a href={insight?.articleUrl || "#"} target="_blank" rel="noopener noreferrer" className="flex items-center justify-between w-full bg-white p-4 rounded-lg border border-indigo-100 shadow-sm hover:shadow-md hover:border-indigo-200 active:scale-98 transition-all group">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-100 p-2 rounded-full text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors"><Hotel size={24} /></div>
                                <span className="font-bold text-lg md:text-xl group-hover:text-blue-700 transition-colors">{selectedCityName}ä½å®¿æ¨è–¦æ¸…å–®</span>
                            </div>
                            <ArrowRight size={24} className="text-gray-400 group-hover:text-blue-500 transition-colors" />
                        </a>
                        <a href={insight?.agodaUrl || "#"} target="_blank" rel="noopener noreferrer" className="flex items-center justify-between w-full bg-white p-4 rounded-lg border border-red-100 shadow-sm hover:shadow-md hover:border-red-200 active:scale-98 transition-all group">
                            <div className="flex items-center gap-3">
                                <div className="bg-red-100 p-2 rounded-full text-red-600 group-hover:bg-red-600 group-hover:text-white transition-colors"><ExternalLink size={24} /></div>
                                <span className="font-bold text-lg md:text-xl group-hover:text-red-600 transition-colors">ç«‹å³å» Agoda æ¶ä¾¿å®œ</span>
                            </div>
                            <ArrowRight size={24} className="text-gray-400 group-hover:text-red-500 transition-colors" />
                        </a>
                    </div>
                </div>
            </div>
        ));

        // --- ä¸»æ‡‰ç”¨ç¨‹å¼ ---
        const JapanHotelCalendar = () => {
            const [data, setData] = useState({});
            const [insights, setInsights] = useState(DEFAULT_INSIGHTS);
            const [loading, setLoading] = useState(true);
            const [isUsingFallback, setIsUsingFallback] = useState(false);
            const [selectedCity, setSelectedCity] = useState(CITIES[0]);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [showGatekeeper, setShowGatekeeper] = useState(false); 
            const [errorMsg, setErrorMsg] = useState(""); 

            // æ¨¡æ“¬å‚™ç”¨è³‡æ–™ç”¢ç”Ÿå™¨
            const generateFallbackData = useCallback(() => {
                const fallbackData = [];
                const today = new Date();
                for(let i=0; i<150; i++) { 
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    const dateStr = DateUtils.formatLocalYYYYMMDD(d);
                    
                    const diffDays = i;
                    const isFutureLocked = diffDays > 30;

                    if (isFutureLocked) {
                        fallbackData.push({ check_in: dateStr, Tokyo_tag: null, Tokyo_heat_index: null });
                    } else {
                        fallbackData.push({
                            check_in: dateStr,
                            Tokyo_tag: i % 7 === 0 ? "ğŸ”´éç†±" : (i % 3 === 0 ? "ğŸŸ¢ä¾¿å®œ" : "ğŸŸ¡æ­£å¸¸"),
                            Tokyo_heat_index: 50 + (i % 20),
                        });
                    }
                }
                return {
                    calendar: fallbackData,
                    insights: {
                        Tokyo: { analysis: "ï¼ˆæ¨¡æ“¬æ•¸æ“šï¼‰ç›®å‰é€£ç·šç•°å¸¸ï¼Œé¡¯ç¤ºå‚™ç”¨è³‡æ–™ã€‚", articleUrl: "#", agodaUrl: "#" },
                        Sapporo: { analysis: "ï¼ˆæ¨¡æ“¬æ•¸æ“šï¼‰ç›®å‰é€£ç·šç•°å¸¸ï¼Œé¡¯ç¤ºå‚™ç”¨è³‡æ–™ã€‚", articleUrl: "#", agodaUrl: "#" },
                    }
                };
            }, []);

            // å…¨åŸŸåˆ¤æ–·æ˜¯å¦ç‚ºå…è²»ä»”
            const isFreeUser = useMemo(() => {
                if (Object.keys(data).length === 0) return false; // è¼‰å…¥ä¸­ä¸é–å®š
                
                const today = new Date();
                today.setHours(0,0,0,0);
                
                // æª¢æŸ¥ç¬¬ 35 å¤©çš„æ•¸æ“š (ç¢ºä¿ > 30 å¤©)
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() + 35);
                const dateStr = DateUtils.formatLocalYYYYMMDD(checkDate);
                
                const cityData = data[dateStr]?.['Tokyo']; // æª¢æŸ¥æ±äº¬æ•¸æ“šæ˜¯å¦å­˜åœ¨
                
                // æœ‰æœ‰æ•ˆæ•¸æ“š -> ä»˜è²»æœƒå“¡ (false)
                if (cityData && cityData.tag && cityData.tag !== 'ğŸ”’' && cityData.tag !== 'âš ï¸ ç„¡æ•¸æ“š') {
                    return false;
                }
                // ç„¡æ•¸æ“šæˆ–é–å®š -> å…è²»æœƒå“¡ (true)
                return true; 
            }, [data]);

            // åˆå§‹åŒ–èˆ‡è³‡æ–™ç²å–
            useEffect(() => {
                const initializeApp = async () => {
                    setLoading(true);
                    let userId = null;

                    try {
                        if (window.liff) {
                            await liff.init({ liffId: CONFIG.LIFF_ID });
                            if (!liff.isInClient()) {
                                console.warn("Not in LINE client.");
                                setShowGatekeeper(true); 
                                setLoading(false);
                                return; 
                            }
                            if (!liff.isLoggedIn()) { liff.login(); return; }
                            const profile = await liff.getProfile();
                            userId = profile.userId;
                        } else { throw new Error("LIFF SDK missing"); }
                    } catch (err) {
                        console.error("LIFF Init Error:", err);
                        if (window.location.hostname !== 'localhost' && !window.location.hostname.includes('127.0.0.1')) {
                             setShowGatekeeper(true);
                             setLoading(false);
                             return;
                        }
                    }

                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 20000); 

                        const response = await fetch(CONFIG.N8N_WEBHOOK_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: userId }), 
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                        // ä¿®æ­£ï¼šå¢åŠ  JSON è§£æéŒ¯èª¤è™•ç†
                        let apiResponse = null;
                        try {
                            apiResponse = await response.json();
                        } catch (e) {
                            throw new Error("API å›å‚³é JSON æ ¼å¼");
                        }
                        
                        processApiResponse(apiResponse);
                        setIsUsingFallback(false);
                        setErrorMsg("");
                    } catch (error) {
                        console.warn("API Error:", error);
                        setErrorMsg(error.message); 
                        processApiResponse(generateFallbackData());
                        setIsUsingFallback(true);
                    } finally {
                        setLoading(false);
                    }
                };

                const processApiResponse = (apiResponse) => {
                    let rawCalendarData = [];
                    let fetchedInsights = null;
                    if (apiResponse) {
                        if (Array.isArray(apiResponse)) {
                            if (apiResponse.length > 0 && apiResponse[0].calendar) {
                                rawCalendarData = apiResponse[0].calendar;
                                fetchedInsights = apiResponse[0].insights;
                            } else { rawCalendarData = apiResponse; }
                        } else if (apiResponse.calendar || apiResponse.data) {
                            rawCalendarData = apiResponse.calendar || apiResponse.data || [];
                            fetchedInsights = apiResponse.insights || null;
                        }
                    }
                    if (fetchedInsights) setInsights(prev => ({ ...prev, ...fetchedInsights }));

                    const formattedData = {};
                    rawCalendarData.forEach(row => {
                        const dateKey = row.check_in; 
                        if (!formattedData[dateKey]) formattedData[dateKey] = {};
                        CITIES.forEach(city => {
                            const tagKey = `${city.id}_tag`; 
                            const indexKey = `${city.id}_heat_index`;
                            formattedData[dateKey][city.id] = {
                                tag: row[tagKey] || "âš ï¸ ç„¡æ•¸æ“š",
                                index: row[indexKey] !== undefined ? row[indexKey] : null
                            };
                        });
                    });
                    setData(formattedData);
                };

                initializeApp();
            }, [generateFallbackData]);

            // Handlers (ä½¿ç”¨ useCallback å„ªåŒ–)
            const handlePrevMonth = useCallback(() => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1)), []);
            const handleNextMonth = useCallback(() => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1)), []);
            const handleCitySelect = useCallback((city) => setSelectedCity(city), []);

            const { days, firstDay, year, month } = useMemo(() => DateUtils.getDaysInMonth(currentDate), [currentDate]);

            // è¨ˆç®—æ˜¯å¦é¡¯ç¤º CTA (ä½¿ç”¨ DateUtils ç¢ºä¿é‚è¼¯ä¸€è‡´)
            const showSubscriptionCTA = useMemo(() => {
                let ctaNeeded = false;
                for (let i = 1; i <= days; i++) {
                    const cellDate = new Date(year, month, i);
                    const diffDays = DateUtils.getDiffDaysFromToday(cellDate);
                    
                    if (diffDays > 30 && diffDays < 150) { 
                        const dateStr = DateUtils.formatLocalYYYYMMDD(cellDate);
                        const dayData = data[dateStr]?.[selectedCity.id];
                        if (!dayData || !dayData.tag || dayData.tag === 'ğŸ”’' || dayData.tag === 'âš ï¸ ç„¡æ•¸æ“š') {
                            ctaNeeded = true;
                            break;
                        }
                    }
                }
                return ctaNeeded;
            }, [year, month, days, data, selectedCity]);

            const currentInsight = insights[selectedCity.id] || DEFAULT_INSIGHTS[selectedCity.id];

            if (showGatekeeper) return <GatekeeperModal />;

            return (
                <div className="bg-white flex flex-col font-sans w-full max-w-md mx-auto shadow-none md:shadow-2xl overflow-hidden md:rounded-xl md:border md:border-gray-200 relative h-screen md:h-[850px]">
                    <Header selectedCity={selectedCity} onSelectCity={handleCitySelect} />
                    <Navigator currentDate={currentDate} onPrevMonth={handlePrevMonth} onNextMonth={handleNextMonth} />
                    <WeekdayHeaders />

                    <div className="p-2 pb-32 overflow-y-auto flex-1 no-scrollbar relative"> 
                        {loading ? (
                            <div className="flex flex-col items-center justify-center py-20 text-gray-400 gap-3">
                                <Loader2 className="animate-spin" size={32} />
                                <span className="text-sm">æ­£åœ¨è¼‰å…¥æœ€æ–°æˆ¿åƒ¹...</span>
                            </div>
                        ) : (
                            <React.Fragment>
                                {isUsingFallback && (
                                    <div className="mx-2 mb-2 p-2 bg-yellow-50 border border-yellow-100 rounded-lg flex items-center gap-2 text-xs text-yellow-700">
                                        <AlertCircle size={14} />
                                        <span>é€£ç·šä¸ç©© ({errorMsg || "API Error"})<br/>ç›®å‰é¡¯ç¤ºå±•ç¤ºç”¨æ•¸æ“š</span>
                                    </div>
                                )}
                                <CalendarGrid 
                                    days={days} firstDay={firstDay} year={year} month={month} 
                                    data={data} selectedCityId={selectedCity.id} 
                                />
                            </React.Fragment>
                        )}

                        {showSubscriptionCTA && (
                            <div className="flex justify-center mb-8 mt-4 w-full animate-fade-in-up px-4">
                                <button className="w-full md:w-auto bg-gradient-to-r from-red-500 to-pink-500 text-white font-bold py-3 px-8 rounded-full shadow-lg flex items-center justify-center gap-3 hover:scale-105 active:scale-95 transition-all border border-white/20">
                                    <Sparkles size={24} className="text-yellow-200 animate-pulse" />
                                    <span className="text-lg md:text-xl tracking-wide drop-shadow-md">è¨‚é–±è§£é–æœªä¾†æˆ¿åƒ¹</span>
                                    <ChevronRight size={24} className="opacity-90" />
                                </button>
                            </div>
                        )}

                        <div className="mb-6 px-2">
                            <div className="flex items-center gap-2 mb-2 text-gray-500"><Info size={14} /><span className="text-[16px]">ç†±åº¦æŒ‡æ•¸è¶Šé«˜ä»£è¡¨æˆ¿åƒ¹è¶Šæ˜‚è²´</span></div>
                            <div className="flex justify-between gap-1 overflow-x-auto no-scrollbar">
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-blue-500"></span>ä½é»</div>
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-green-500"></span>ä¾¿å®œ</div>
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-yellow-500"></span>æ­£å¸¸</div>
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-orange-500"></span>ç¨è²´</div>
                                <div className="flex items-center gap-1 text-[18px] text-gray-500"><span className="w-4 h-4 rounded-full bg-red-500"></span>éç†±</div>
                            </div>
                        </div>

                        {/* ä¿®æ”¹: ä½¿ç”¨ isLocked={isFreeUser} å‚³å…¥å…¨åŸŸå…è²»åˆ¤æ–· */}
                        <AnalysisSection 
                            insight={currentInsight} 
                            isLocked={isFreeUser} 
                            selectedCityName={selectedCity.name} 
                        />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<JapanHotelCalendar />);
    </script>
</body>
</html>
